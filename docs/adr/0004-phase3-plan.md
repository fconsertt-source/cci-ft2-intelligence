# ADR 0004 — خطة المرحلة 3: تحويل تدريجي باستخدام Composition Root

تاريخ: 2026-01-31

الحالة: مقبول

## السياق

هذه ADR توثق القرارات والخطوات المتعلقة بالمرحلة 3 من خطة اعتماد الهيكل الجديد: تحويل تدريجي للمكونات ليعتمد كل عرض على DTOs وDI.

## القرار

1. إنشاء DTOs أساسية (`VaccineDTO`, `CenterDTO`) ومابّرات (`application/mappers/*`) لتحويل الكيانات الحالية.
2. إضافة `src/infrastructure/adapters/ft2_reader_adapter.py` لاحتواء منطق القراءة/التحليل ضمن طبقة Infrastructure.
3. توحيد التسجيل عبر `src/infrastructure/logging.py` واستخدامه في السكربتات والـ Use Cases.
4. تعديل `scripts/run_ft2_pipeline.py` ليأخذ Use Case من `src/shared/di_container.py` ويبدأ استخدام DTOs تدريجيًا.

## العواقب

- يسمح بتحول تدريجي مع الحد من كسر الواردات.
- يتطلب تحديث تدريجي لباقي السكربتات وواجهات العرض لاستبدال الكيانات بـ DTOs.

## عناصر العمل المتبقية

- إنشاء مابّرات إضافية (Packet, وغيرها) حسب الحاجة.
- تحديث كل السكربتات وAPI controllers لاستخدام DI وDTOs.
- توحيد تسجيل الأخطاء والاستثناءات عبر infra/shared.
